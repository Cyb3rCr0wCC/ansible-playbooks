{% set domains = [
    {'name': item.domain, 'cert': ssl_cert, 'key': ssl_key, 'org': domain1},
    {'name': item.domain2 if item.domain2 is defined else None, 'cert': ssl_cert, 'key': ssl_key, 'org': domain2},
    {'name': item.domain3 if item.domain3 is defined else None, 'cert': ssl_cert, 'key': ssl_key , 'org': domain3},
    {'name': item.domain4 if item.domain4 is defined else None, 'cert': ssl_cert, 'key': ssl_key, 'org': domain4},
] %}

{% for domain in domains %}
{% if domain.name is not none %}
server {
    listen 443 ssl;
    {% if item.name.startswith('ag') %}
    server_name {{domain.name[3:]}} *.{{ domain.name[3:] }};
    {% else %}
    server_name {{ domain.name }};
    {% endif %}
    {% if item.name.startswith('ag') %}
    ssl_certificate     {{ cert_path }}/{{ domain.org }}/{{ domain.cert }};
    ssl_certificate_key {{ cert_path }}/{{ domain.org }}/{{ domain.key }};
    {% else %}
    {% if domain.org.startswith('mekdep.org')%}
    ssl_certificate     {{ cert_path }}/{{ domain.org }}/{{ domain.cert }};
    ssl_certificate_key {{ cert_path }}/{{ domain.org }}/{{ domain.key }};
    {% else %}
    ssl_certificate     {{ cert_path }}/{{ domain.org }}/fullchain.pem;
    ssl_certificate_key {{ cert_path }}/{{ domain.org }}/privkey.pem;
    {% endif %}
    {% endif %}
    ssl_protocols       TLSv1 TLSv1.1 TLSv1.2 TLSv1.3;
    ssl_ciphers         HIGH:!aNULL:!MD5;
    error_page 403 = /403.html;
    error_page 502 /custom_503.html;
    index index.php index.html;
    {% if domain.org == domain_edu or domain.org == domain_org %}
    include '{{ item.app_path }}.old';
    {% else %}
    include '{{ item.app_path }}';
    {% endif %}
    
    error_log /var/log/nginx/{{ item.name }}_error.log;
    access_log /var/log/nginx/{{ item.name }}_access.log;
}
{% endif %}
{% endfor %}

server {
  listen 80;
  return 301 https://$host$request_uri;
}